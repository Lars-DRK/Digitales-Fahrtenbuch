<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitales Fahrtenbuch - DRK</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DRK Buch">
    <meta name="theme-color" content="#b91c1c">
    
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Red_Cross_icon.svg/1024px-Red_Cross_icon.svg.png">
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Red_Cross_icon.svg/1024px-Red_Cross_icon.svg.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            background-image: url('https://www.drk.de/fileadmin/DRK-Layout/Logos/DRK-Kompaktlogo-RGB.svg');
            background-size: 80%;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            position: relative;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(243, 244, 246, 0.85);
            z-index: -1;
        }

        .hidden-print { display: none !important; }
        @media print {
            .no-print { display: none !important; }
            .hidden-print { display: block !important; }
            body { background-color: white; background-image: none; }
            body::before { display: none; }
        }
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 50; display: flex; justify-content: center; align-items: center; }
        
        .log-table th { font-size: 0.75rem; vertical-align: top; background-color: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; padding: 4px; }
        .log-table td { font-size: 0.8rem; border: 1px solid #e5e7eb; padding: 4px; vertical-align: middle; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loader"><div class="text-xl font-bold text-red-600"><i class="fa-solid fa-circle-notch fa-spin"></i> Lade Daten...</div></div>

    <nav class="bg-red-700 text-white shadow-lg no-print relative z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-truck-medical text-2xl"></i>
                <h1 class="text-xl font-bold hidden md:block">Fahrtenbuch Manager</h1>
                <h1 class="text-xl font-bold md:hidden">Fahrtenbuch</h1>
            </div>
            <div class="space-x-2 text-sm md:text-base">
                <button onclick="showSection('logbook')" class="hover:text-red-200"><i class="fa-solid fa-book"></i> Buch</button>
                <button onclick="showSection('stats')" class="hover:text-red-200"><i class="fa-solid fa-chart-line"></i> Stats</button>
                <button onclick="showSection('vehicles')" class="hover:text-red-200"><i class="fa-solid fa-car"></i> KFZ</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-2 py-6 relative z-10">
        
        <div id="logbook-section" class="space-y-6">
            <div class="bg-white/90 p-4 rounded-lg shadow-md border-t-4 border-red-600 no-print backdrop-blur-sm">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-to-square"></i> Neue Fahrt</h2>
                <form id="entryForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-3">
                    <div class="lg:col-span-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Fahrzeug</label>
                        <select id="vehicleSelect" class="w-full mt-1 p-2 border rounded bg-gray-50" onchange="updateStartKm()"></select>
                    </div>
                    <div class="lg:col-span-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Fahrer</label>
                        <input type="text" id="driver" class="w-full mt-1 p-2 border rounded" placeholder="Name" required>
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Datum</label>
                        <input type="date" id="date" class="w-full mt-1 p-2 border rounded" required>
                    </div>

                    <div class="lg:col-span-6">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Fahrtzweck</label>
                        <input type="text" id="purpose" class="w-full mt-1 p-2 border rounded" placeholder="z.B. Einsatz" required>
                    </div>
                    <div class="lg:col-span-6">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Fahrstrecke</label>
                        <input type="text" id="route" class="w-full mt-1 p-2 border rounded" placeholder="Von - Nach" required>
                    </div>

                    <div class="lg:col-span-6 bg-blue-50/90 p-2 rounded border border-blue-100">
                        <span class="text-xs font-bold text-blue-800 uppercase block mb-1">Beginn der Fahrt</span>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500">Uhrzeit</label>
                                <input type="time" id="startTime" class="w-full p-1 border rounded bg-white" required>
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500">KM-Stand</label>
                                <input type="number" id="startKm" class="w-full p-1 border rounded bg-gray-200 text-gray-600 transition-colors" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-6 bg-green-50/90 p-2 rounded border border-green-100">
                        <span class="text-xs font-bold text-green-800 uppercase block mb-1">Ende der Fahrt</span>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500">Uhrzeit</label>
                                <input type="time" id="endTime" class="w-full p-1 border rounded bg-white" required>
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500">KM-Stand</label>
                                <input type="number" id="endKm" class="w-full p-1 border rounded bg-white" oninput="calcDist()" required>
                            </div>
                        </div>
                        <div class="mt-1 text-right">
                            <span class="text-xs text-green-700">Gefahren: </span>
                            <span id="distanceDisplay" class="font-bold text-lg">0</span> km
                            <input type="hidden" id="distance">
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Treibstoff</label>
                        <input type="text" id="fuel" class="w-full mt-1 p-2 border rounded" placeholder="Liter / -">
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Öl</label>
                        <input type="text" id="oil" class="w-full mt-1 p-2 border rounded" placeholder="Liter / -">
                    </div>
                    <div class="lg:col-span-8">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Bemerkungen</label>
                        <input type="text" id="remarks" class="w-full mt-1 p-2 border rounded" placeholder="...">
                    </div>

                    <div class="lg:col-span-12 flex justify-between items-center mt-2 pt-2 border-t">
                        <div id="syncStatus" class="text-xs text-gray-400">System bereit</div>
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded shadow flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> Speichern
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white/90 p-3 rounded-lg shadow-sm flex flex-col md:flex-row gap-3 items-end no-print backdrop-blur-sm">
                <div class="w-full md:flex-1">
                    <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Suche..." class="w-full p-2 border rounded text-sm">
                </div>
                <div class="w-full md:w-auto">
                    <select id="filterVehicle" onchange="renderTable()" class="w-full p-2 border rounded text-sm"><option value="all">Alle Fahrzeuge</option></select>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="downloadPdf()" class="flex-1 bg-red-800 text-white px-3 py-2 rounded text-sm hover:bg-red-900 shadow">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="window.print()" class="flex-1 bg-gray-700 text-white px-3 py-2 rounded text-sm hover:bg-gray-800">
                        <i class="fa-solid fa-print"></i> Druck
                    </button>
                </div>
            </div>

            <div class="bg-white shadow-md rounded-lg overflow-hidden overflow-x-auto">
                <table class="w-full min-w-[800px] border-collapse log-table">
                    <thead>
                        <tr>
                            <th class="w-16">Tag/Mon</th>
                            <th class="w-32">Zweck</th>
                            <th class="w-32">Strecke</th>
                            <th class="w-20">Beginn<br>Uhr</th>
                            <th class="w-20">Beginn<br>KM</th>
                            <th class="w-20">Ende<br>Uhr</th>
                            <th class="w-20">Ende<br>KM</th>
                            <th class="w-16">gef.<br>KM</th>
                            <th class="w-12">Sprit</th>
                            <th class="w-12">Öl</th>
                            <th class="w-24">Fahrer</th>
                            <th class="w-32">Info</th>
                            <th class="no-print w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody" class="text-sm bg-white"></tbody>
                </table>
            </div>
        </div>

        <div id="stats-section" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-white drop-shadow-md">Statistik</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white/90 p-4 rounded shadow backdrop-blur-sm"><canvas id="chartVehicles"></canvas></div>
                <div class="bg-white/90 p-4 rounded shadow backdrop-blur-sm"><canvas id="chartMonths"></canvas></div>
            </div>
        </div>

        <div id="vehicles-section" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-white drop-shadow-md">Fahrzeuge & QR Codes</h2>
            
            <div class="bg-white/90 p-6 rounded shadow mt-6 backdrop-blur-sm border-l-4 border-green-500">
                <h3 class="font-bold mb-4 text-lg">Neues Fahrzeug anlegen</h3>
                <div class="flex gap-4 flex-wrap items-end">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-xs text-gray-500 uppercase font-bold">Fahrzeugname</label>
                        <input type="text" id="newVehicleName" placeholder="z.B. NEF 1" class="border p-2 rounded w-full">
                    </div>
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-xs text-gray-500 uppercase font-bold">Kennzeichen</label>
                        <input type="text" id="newVehiclePlate" placeholder="z.B. UN-RK 1234" class="border p-2 rounded w-full">
                    </div>
                    <button onclick="addNewVehicle()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold shadow">
                        <i class="fa-solid fa-plus"></i> Hinzufügen
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="vehicleCardContainer"></div>
            
            <div class="bg-white/90 p-6 rounded shadow mt-6 backdrop-blur-sm">
                <h3 class="font-bold mb-4">Fahrzeug umbenennen</h3>
                <div class="flex gap-4">
                     <select id="editVehicleSelect" class="border p-2 rounded flex-1"></select>
                     <input type="text" id="editVehicleName" placeholder="Neue Bezeichnung" class="border p-2 rounded flex-1">
                     <button onclick="updateVehicleName()" class="bg-blue-600 text-white px-4 py-2 rounded">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <div id="printQrModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center no-print z-50">
        <div class="bg-white p-8 rounded shadow-xl text-center max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4" id="modalVehicleName"></h3>
            <div id="modalQrCode" class="flex justify-center mb-4"></div>
            <button onclick="document.getElementById('printQrModal').classList.add('hidden')" class="bg-gray-400 text-white px-4 py-2 rounded">Schließen</button>
        </div>
    </div>
    
    <div id="printableArea" class="hidden-print flex flex-col items-center justify-center h-screen">
        <h1 class="text-4xl font-bold mb-4">Scan QR</h1>
        <div id="printQrTarget" class="mb-4 transform scale-150"></div>
        <h2 id="printQrTitle" class="text-2xl font-bold"></h2>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCCZK5xpRZYnWDJsl0v2ucixLseOp_t2Kw",
            authDomain: "drk-fahrtenbuch.firebaseapp.com",
            databaseURL: "https://drk-fahrtenbuch-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "drk-fahrtenbuch",
            storageBucket: "drk-fahrtenbuch.firebasestorage.app",
            messagingSenderId: "470329025952",
            appId: "1:470329025952:web:6f82c40e7f2e29dd6270c5"
        };

        const PASSWORD = "Dunant2026";
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let vehicles = [];
        let entries = [];
        
        // Standard Fahrzeuge (BT-LKW wurde entfernt)
        const defaultVehicles = [
            { id: 'v1', name: 'KTW', plate: 'NRW 8-1024', currentKm: 0 },
            { id: 'v3', name: 'BT-Kombi', plate: 'NRW 8-1169', currentKm: 0 },
            { id: 'v4', name: 'MTW', plate: 'UN-RK 2017', currentKm: 0 }
        ];

        // --- DATA SYNC ---
        onValue(ref(db, 'vehicles'), (snap) => {
            const data = snap.val();
            if(!data) {
                defaultVehicles.forEach(v => set(ref(db, 'vehicles/' + v.id), v));
            } else {
                vehicles = Object.values(data);
                initSelectors();
                renderVehicleCards();
                const vid = new URLSearchParams(window.location.search).get('vid');
                if(vid && document.getElementById('vehicleSelect')) document.getElementById('vehicleSelect').value = vid;
            }
            updateStartKm();
        });

        onValue(ref(db, 'entries'), (snap) => {
            const data = snap.val();
            entries = data ? Object.entries(data).map(([key, val]) => ({ id: key, ...val })) : [];
            entries.sort((a, b) => new Date(b.date + 'T' + b.startTime) - new Date(a.date + 'T' + a.startTime));
            renderTable();
            updateStartKm();
            renderCharts();
            document.getElementById('loader').style.display = 'none';
        });

        // --- VEHICLE ACTIONS ---
        window.addNewVehicle = () => {
            if(prompt("Passwort:") !== PASSWORD) return alert("Falsches Passwort!");
            const name = document.getElementById('newVehicleName').value;
            const plate = document.getElementById('newVehiclePlate').value;
            if(!name || !plate) return alert("Bitte Name und Kennzeichen eingeben.");

            const newRef = push(ref(db, 'vehicles'));
            set(newRef, { id: newRef.key, name, plate, currentKm: 0 }).then(() => {
                alert("Fahrzeug hinzugefügt!");
                document.getElementById('newVehicleName').value = '';
                document.getElementById('newVehiclePlate').value = '';
            });
        };

        window.deleteVehicle = (id) => {
            if (confirm("Fahrzeug wirklich löschen?")) {
                if (prompt("Passwort zur Bestätigung:") === PASSWORD) {
                    remove(ref(db, 'vehicles/' + id)).then(() => alert("Gelöscht."));
                } else {
                    alert("Falsches Passwort!");
                }
            }
        };

        window.updateVehicleName = () => {
            if(prompt("Passwort:") === PASSWORD) {
                const id = document.getElementById('editVehicleSelect').value;
                const name = document.getElementById('editVehicleName').value;
                if(name) update(ref(db, 'vehicles/' + id), { name }).then(() => {
                    alert("Gespeichert!");
                    document.getElementById('editVehicleName').value = '';
                });
            } else alert("Falsches Passwort!");
        };

        // --- LOGIC & RENDERING ---
        window.updateStartKm = () => {
            const vid = document.getElementById('vehicleSelect').value;
            if(!vid) return;
            const vEntries = entries.filter(e => e.vehicleId === vid);
            const startInput = document.getElementById('startKm');
            if(vEntries.length > 0) {
                startInput.value = vEntries[0].endKm; 
                startInput.readOnly = true;
                startInput.className = "w-full p-1 border rounded bg-gray-200 text-gray-600";
            } else {
                const v = vehicles.find(veh => veh.id === vid);
                startInput.value = v ? v.currentKm : 0;
                startInput.readOnly = false;
                startInput.className = "w-full p-1 border rounded bg-white text-gray-900 border-red-500";
            }
            document.getElementById('endKm').value = '';
            document.getElementById('distanceDisplay').innerText = '0';
        };

        window.calcDist = () => {
            const s = parseFloat(document.getElementById('startKm').value)||0;
            const e = parseFloat(document.getElementById('endKm').value)||0;
            const d = e > s ? (e-s).toFixed(1) : 0;
            document.getElementById('distance').value = d;
            document.getElementById('distanceDisplay').innerText = d;
        };

        document.getElementById('entryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const vid = document.getElementById('vehicleSelect').value;
            const vObj = vehicles.find(v => v.id === vid);
            const newEntry = {
                vehicleId: vid,
                vehicleName: vObj.name,
                plate: vObj.plate,
                date: document.getElementById('date').value, 
                purpose: document.getElementById('purpose').value, 
                route: document.getElementById('route').value, 
                startTime: document.getElementById('startTime').value, 
                startKm: parseFloat(document.getElementById('startKm').value), 
                endTime: document.getElementById('endTime').value, 
                endKm: parseFloat(document.getElementById('endKm').value), 
                dist: parseFloat(document.getElementById('distance').value), 
                fuel: document.getElementById('fuel').value, 
                oil: document.getElementById('oil').value, 
                driver: document.getElementById('driver').value, 
                remarks: document.getElementById('remarks').value, 
                timestamp: Date.now()
            };
            push(ref(db, 'entries'), newEntry).then(() => {
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('vehicleSelect').value = vid;
                updateStartKm();
                alert("Gespeichert!");
            });
        });

        window.deleteEntry = (id) => {
            if(prompt("Passwort:") === PASSWORD && confirm("Eintrag löschen?")) remove(ref(db, 'entries/' + id));
        };

        window.renderTable = () => {
            const tbody = document.getElementById('logTableBody');
            tbody.innerHTML = '';
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filterVid = document.getElementById('filterVehicle').value;
            const filtered = entries.filter(e => (filterVid === 'all' || e.vehicleId === filterVid) && (e.driver.toLowerCase().includes(search) || e.purpose.toLowerCase().includes(search)));
            filtered.forEach(e => {
                tbody.innerHTML += `
                    <tr class="hover:bg-blue-50 border-b border-gray-200">
                        <td>${new Date(e.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })}</td>
                        <td class="truncate max-w-[100px]">${e.purpose}</td>
                        <td class="truncate max-w-[100px]">${e.route}</td>
                        <td>${e.startTime}<br><span class="text-xs text-gray-500">KM</span></td>
                        <td>${e.startKm}</td>
                        <td>${e.endTime}<br><span class="text-xs text-gray-500">KM</span></td>
                        <td class="font-bold">${e.endKm}</td>
                        <td class="text-center font-bold bg-gray-50">${e.dist}</td>
                        <td>${e.fuel || '-'}</td>
                        <td>${e.oil || '-'}</td>
                        <td class="truncate max-w-[80px]">${e.driver}</td>
                        <td class="truncate max-w-[100px] text-xs italic">${e.remarks || ''}</td>
                        <td class="text-center no-print">
                            <button onclick="deleteEntry('${e.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        };

        window.renderVehicleCards = () => {
            const c = document.getElementById('vehicleCardContainer'); c.innerHTML = '';
            const url = window.location.href.split('?')[0];
            vehicles.forEach(v => {
                const id = `qr-${v.id}`;
                c.innerHTML += `
                    <div class="bg-white/95 p-4 rounded shadow text-center backdrop-blur-sm relative group">
                        <button onclick="deleteVehicle('${v.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-600 transition-colors">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <h3 class="font-bold">${v.name}</h3>
                        <p class="text-xs mb-2">${v.plate}</p>
                        <div id="${id}" class="flex justify-center mb-2"></div>
                        <button onclick="document.getElementById('printQrModal').classList.remove('hidden');renderModalQR('${v.id}')" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">QR Drucken</button>
                    </div>`;
                setTimeout(() => new QRCode(document.getElementById(id), { text: `${url}?vid=${v.id}`, width:100, height:100 }), 100);
            });
        };

        window.renderModalQR = (vid) => {
            const v = vehicles.find(veh => veh.id === vid);
            document.getElementById('modalVehicleName').innerText = v.name;
            const url = window.location.href.split('?')[0] + '?vid=' + vid;
            document.getElementById('modalQrCode').innerHTML = "";
            new QRCode(document.getElementById('modalQrCode'), { text: url, width: 200, height: 200 });
            document.getElementById('printQrTitle').innerText = v.name;
            document.getElementById('printQrTarget').innerHTML = "";
            new QRCode(document.getElementById('printQrTarget'), { text: url, width: 256, height: 256 });
        }

        window.showSection = (id) => {
            ['logbook-section', 'stats-section', 'vehicles-section'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id + '-section').classList.remove('hidden');
            if(id === 'stats') renderCharts();
        };

        function initSelectors() {
            ['vehicleSelect', 'filterVehicle', 'editVehicleSelect'].forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                el.innerHTML = id === 'filterVehicle' ? '<option value="all">Alle Fahrzeuge</option>' : '';
                vehicles.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.id;
                    opt.text = `${v.name} (${v.plate})`;
                    el.appendChild(opt);
                });
            });
        }

        window.renderCharts = () => {
            if(window.chartV) window.chartV.destroy();
            if(window.chartM) window.chartM.destroy();
            const kmMap = {}; const monthArr = Array(12).fill(0);
            entries.forEach(e => {
                kmMap[e.vehicleName] = (kmMap[e.vehicleName]||0) + (e.dist||0);
                monthArr[new Date(e.date).getMonth()]++;
            });
            window.chartV = new Chart(document.getElementById('chartVehicles'), { type: 'doughnut', data: { labels: Object.keys(kmMap), datasets: [{ data: Object.values(kmMap), backgroundColor: ['#ef4444','#3b82f6','#10b981','#f59e0b'] }] } });
            window.chartM = new Chart(document.getElementById('chartMonths'), { type: 'bar', data: { labels: ['Jan','Feb','Mrz','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'], datasets: [{ label:'Fahrten', data: monthArr, backgroundColor: '#dc2626' }] } });
        };

        window.downloadPdf = () => {
            if(prompt("Passwort:") !== PASSWORD) return alert("Falsch!");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); 
            const filterVid = document.getElementById('filterVehicle').value;
            const filtered = entries.filter(e => filterVid === 'all' || e.vehicleId === filterVid);
            let title = "Fahrtenbuch";
            if(filterVid !== 'all') {
                const v = vehicles.find(x => x.id === filterVid);
                if(v) title += ` - ${v.name} (${v.plate})`;
            }
            doc.text(title, 14, 15);
            doc.autoTable({
                startY: 20,
                head: [['Tag/Mon', 'Zweck', 'Strecke', 'Beginn', 'KM', 'Ende', 'KM', 'Gef.', 'Sprit', 'Öl', 'Fahrer', 'Bem.']],
                body: filtered.map(e => [new Date(e.date).toLocaleDateString('de-DE').substring(0,5), e.purpose, e.route, e.startTime, e.startKm, e.endTime, e.endKm, e.dist, e.fuel, e.oil, e.driver, e.remarks]),
                theme: 'grid', styles: { fontSize: 8 }
            });
            doc.save('Fahrtenbuch.pdf');
        };

        // Init
        document.getElementById('date').valueAsDate = new Date();
        const t = new Date().toTimeString().substring(0,5);
        document.getElementById('startTime').value = t;
        document.getElementById('endTime').value = t;

    </script>
</body>
</html>
